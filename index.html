<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Music Recommendation XAI - Dynamic Center Analysis</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', sans-serif;
    background: #000;
    color: #fff;
    overflow: hidden;
}

/* Album Intro Screen */
.intro-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #000;
    z-index: 2000;
    opacity: 0;
}

.intro-screen.visible {
    opacity: 1;
}

.album-cover-intro {
    width: 400px;
    height: 400px;
    border-radius: 30px;
    background: linear-gradient(135deg, #ff0080, #ff4da6);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 120px;
    font-weight: 900;
    margin-bottom: 40px;
    box-shadow: 0 40px 100px rgba(255, 0, 128, 0.6);
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.song-info-intro {
    text-align: center;
}

.song-title-intro {
    font-size: 64px;
    font-weight: 900;
    margin-bottom: 16px;
}

.artist-intro {
    font-size: 36px;
    color: rgba(255,255,255,0.6);
}

/* Feature Cards Screen */
.features-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #000;
    z-index: 1900;
    opacity: 0;
    pointer-events: none;
}

.features-screen.visible {
    opacity: 1;
    pointer-events: all;
}

.features-title {
    font-size: 48px;
    font-weight: 900;
    background: linear-gradient(135deg, #ff0080, #00d4ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 60px;
}

.features-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 40px;
    max-width: 1000px;
}

.feature-card {
    background: rgba(255,255,255,0.03);
    backdrop-filter: blur(20px);
    border: 2px solid rgba(255,255,255,0.1);
    border-radius: 30px;
    padding: 40px;
    text-align: center;
    transition: all 0.3s ease;
    opacity: 0;
    transform: translateY(30px);
}

.feature-card.visible {
    opacity: 1;
    transform: translateY(0);
}

.feature-card:hover {
    transform: translateY(-10px);
    border-color: rgba(255,255,255,0.3);
}

.feature-card.f1 { border-top: 4px solid #ff0080; }
.feature-card.f2 { border-top: 4px solid #00d4ff; }
.feature-card.f3 { border-top: 4px solid #a855f7; }
.feature-card.f4 { border-top: 4px solid #ffd700; }

.feature-icon-big {
    font-size: 56px;
    margin-bottom: 20px;
}

.feature-label {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 12px;
}

.feature-value-big {
    font-size: 72px;
    font-weight: 900;
    margin-bottom: 12px;
}

.feature-card.f1 .feature-value-big { color: #ff0080; }
.feature-card.f2 .feature-value-big { color: #00d4ff; }
.feature-card.f3 .feature-value-big { color: #a855f7; }
.feature-card.f4 .feature-value-big { color: #ffd700; }

.feature-desc {
    font-size: 14px;
    color: rgba(255,255,255,0.6);
    line-height: 1.6;
}

/* 3D Canvas */
#canvas-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
}

#canvas-container.visible {
    opacity: 1;
}

.ui-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10;
    opacity: 0;
}

.ui-overlay.visible {
    opacity: 1;
}

.stage-info {
    position: absolute;
    top: 40px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 24px;
    padding: 20px 50px;
    text-align: center;
}

.stage-title {
    font-size: 32px;
    font-weight: 900;
    background: linear-gradient(135deg, #ff0080, #00d4ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 8px;
}

.stage-desc {
    font-size: 14px;
    color: rgba(255,255,255,0.6);
    text-transform: uppercase;
    letter-spacing: 2px;
}

.center-song-info {
    position: absolute;
    top: 120px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.9);
    backdrop-filter: blur(20px);
    border: 2px solid #ff0080;
    border-radius: 20px;
    padding: 20px 30px;
    text-align: center;
    min-width: 300px;
}

.center-label {
    font-size: 12px;
    color: rgba(255,255,255,0.5);
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 8px;
}

.center-song-name {
    font-size: 24px;
    font-weight: 900;
    color: #ff0080;
    margin-bottom: 4px;
}

.center-artist {
    font-size: 14px;
    color: rgba(255,255,255,0.6);
    margin-bottom: 16px;
}

.center-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

.center-stat {
    background: rgba(255,255,255,0.05);
    padding: 8px 12px;
    border-radius: 10px;
    font-size: 11px;
}

.center-stat strong {
    display: block;
    font-size: 20px;
    font-weight: 900;
    margin-bottom: 2px;
}

.center-stat.s1 { border-left: 3px solid #ff0080; }
.center-stat.s2 { border-left: 3px solid #00d4ff; }
.center-stat.s3 { border-left: 3px solid #a855f7; }
.center-stat.s4 { border-left: 3px solid #ffd700; }

.controls {
    position: absolute;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 15px;
    pointer-events: all;
}

.control-btn {
    background: rgba(255,255,255,0.05);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255,255,255,0.2);
    color: white;
    padding: 14px 40px;
    border-radius: 25px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.control-btn:hover {
    background: rgba(255,255,255,0.1);
    border-color: #ff0080;
    box-shadow: 0 0 20px rgba(255,0,128,0.5);
    transform: translateY(-2px);
}

.control-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

/* Node Labels */
.node-label {
    position: absolute;
    background: rgba(0,0,0,0.95);
    backdrop-filter: blur(20px);
    border: 2px solid;
    border-radius: 20px;
    padding: 16px 20px;
    pointer-events: none;
    opacity: 0;
    transform: translate(-50%, -120%);
    transition: opacity 0.3s ease;
    min-width: 240px;
    text-align: center;
    z-index: 100;
    box-shadow: 0 10px 40px rgba(0,0,0,0.8);
}

.node-label.visible {
    opacity: 1;
}

.node-label.center { border-color: #ff0080; background: rgba(255,0,128,0.1); }
.node-label.candidate { border-color: #00d4ff; }
.node-label.other { border-color: #a855f7; }
.node-label.final { border-color: #ffd700; background: rgba(255,215,0,0.1); }

.node-label-name {
    font-size: 20px;
    font-weight: 900;
    margin-bottom: 4px;
}

.node-label-artist {
    font-size: 12px;
    color: rgba(255,255,255,0.5);
    margin-bottom: 16px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.node-label-scores {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.node-label-score {
    background: rgba(255,255,255,0.05);
    padding: 8px 10px;
    border-radius: 8px;
    font-size: 11px;
    text-transform: uppercase;
}

.node-label-score strong {
    font-size: 18px;
    font-weight: 900;
    display: block;
    margin-bottom: 2px;
}

.node-label-score.f { border-left: 3px solid #ff0080; }
.node-label-score.s { border-left: 3px solid #00d4ff; }
.node-label-score.so { border-left: 3px solid #a855f7; }
.node-label-score.p { border-left: 3px solid #ffd700; }

.progress-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    height: 4px;
    background: linear-gradient(90deg, #ff0080, #00d4ff, #a855f7, #ffd700);
    width: 0%;
    transition: width 0.5s ease;
    z-index: 1000;
}
</style>
</head>
<body>

<!-- Intro Screen -->
<div class="intro-screen" id="introScreen">
    <div class="album-cover-intro">JB</div>
    <div class="song-info-intro">
        <div class="song-title-intro">Sorry</div>
        <div class="artist-intro">Justin Bieber</div>
    </div>
</div>

<!-- Features Screen -->
<div class="features-screen" id="featuresScreen">
    <div class="features-title">Audio Features Analysis</div>
    <div class="features-grid">
        <div class="feature-card f1">
            <div class="feature-icon-big">üòä</div>
            <div class="feature-label">Feeling</div>
            <div class="feature-value-big">43%</div>
            <div class="feature-desc">Í∞êÏ†ïÏ†Å Î∞ùÍ∏∞ - Ï§ëÎ¶ΩÏ†ÅÏù¥Í≥† Í∑†ÌòïÏû°Ìûå Í∞êÏ†ï</div>
        </div>
        <div class="feature-card f2">
            <div class="feature-icon-big">üíÉ</div>
            <div class="feature-label">Style</div>
            <div class="feature-value-big">65%</div>
            <div class="feature-desc">ÌÖúÌè¨ÏôÄ Î¶¨Îì¨ - Ï∂§Ï∂îÍ∏∞ Ï†ÅÎãπÌïú Í≥°</div>
        </div>
        <div class="feature-card f3">
            <div class="feature-icon-big">‚ö°</div>
            <div class="feature-label">Sound</div>
            <div class="feature-value-big">76%</div>
            <div class="feature-desc">ÏùåÏïÖÏùò Í∞ïÎ†¨Ìï® - ÏóêÎÑàÏ†úÌã±ÌïòÍ≥† ÌôúÍ∏∞Ï∞¨ Í≥°</div>
        </div>
        <div class="feature-card f4">
            <div class="feature-icon-big">‚≠ê</div>
            <div class="feature-label">Preference</div>
            <div class="feature-value-big">85</div>
            <div class="feature-desc">ÏÇ¨Ïö©Ïûê ÏÑ†Ìò∏ Ïû•Î•¥ÏôÄÏùò ÏùºÏπòÎèÑ</div>
        </div>
    </div>
</div>

<!-- 3D Visualization -->
<div id="canvas-container"></div>

<div class="ui-overlay">
    <div class="stage-info">
        <div class="stage-title" id="stageTitle">Ï¥àÍ∏∞Ìôî</div>
        <div class="stage-desc" id="stageDesc">3D Vector Space</div>
    </div>

    <div class="center-song-info" id="centerSongInfo" style="display:none;">
        <div class="center-label">Current Center Song</div>
        <div class="center-song-name" id="centerName">Sorry</div>
        <div class="center-artist" id="centerArtist">Justin Bieber</div>
        <div class="center-stats">
            <div class="center-stat s1"><strong id="centerFeeling">43</strong>Feeling</div>
            <div class="center-stat s2"><strong id="centerStyle">65</strong>Style</div>
            <div class="center-stat s3"><strong id="centerSound">76</strong>Sound</div>
            <div class="center-stat s4"><strong id="centerPref">85</strong>Preference</div>
        </div>
    </div>

    <div id="nodeLabels"></div>

    <div class="controls">
        <button class="control-btn" onclick="prevStage()" id="prevBtn">‚óÄ Prev</button>
        <button class="control-btn" onclick="nextStage()" id="nextBtn">Next ‚ñ∂</button>
        <button class="control-btn" onclick="restartShow()" id="restartBtn">üîÑ Restart</button>
    </div>

    <div class="progress-bar" id="progressBar"></div>
</div>

<script>
// Real Spotify Data (valence, danceability, energy in 0-100 scale)
const SONGS = [
    {
        name: "Sorry",
        artist: "Justin Bieber",
        feeling: 43,
        style: 65,
        sound: 76,
        preference: 85
    },
    {
        name: "Blinding Lights",
        artist: "The Weeknd",
        feeling: 36,
        style: 51,
        sound: 73,
        preference: 95
    },
    {
        name: "Shape of You",
        artist: "Ed Sheeran",
        feeling: 93,
        style: 83,
        sound: 65,
        preference: 93
    },
    {
        name: "Levitating",
        artist: "Dua Lipa",
        feeling: 92,
        style: 70,
        sound: 70,
        preference: 88
    },
    {
        name: "Closer",
        artist: "The Chainsmokers",
        feeling: 52,
        style: 75,
        sound: 52,
        preference: 82
    },
    {
        name: "Sunflower",
        artist: "Post Malone",
        feeling: 76,
        style: 76,
        sound: 48,
        preference: 90
    },
    {
        name: "Don't Start Now",
        artist: "Dua Lipa",
        feeling: 75,
        style: 79,
        sound: 79,
        preference: 84
    },
    {
        name: "Watermelon Sugar",
        artist: "Harry Styles",
        feeling: 82,
        style: 55,
        sound: 78,
        preference: 86
    },
    {
        name: "Someone You Loved",
        artist: "Lewis Capaldi",
        feeling: 24,
        style: 51,
        sound: 41,
        preference: 87
    },
    {
        name: "Dance Monkey",
        artist: "Tones and I",
        feeling: 82,
        style: 82,
        sound: 59,
        preference: 89
    }
];

let scene, camera, renderer, nodes = [];
let currentStage = -2; // -2: intro, -1: features, 0-4: 3D stages
let centerSongIndex = 0;

function initApp() {
    showIntro();
}

function showIntro() {
    const intro = document.getElementById('introScreen');
    gsap.to(intro, { opacity: 1, duration: 1, ease: 'power2.out' });
    setTimeout(() => {
        gsap.to(intro, {
            opacity: 0,
            duration: 0.8,
            ease: 'power2.in',
            onComplete: () => {
                intro.style.display = 'none';
                showFeatures();
            }
        });
    }, 3000);
}

function showFeatures() {
    const features = document.getElementById('featuresScreen');
    features.classList.add('visible');
    
    const cards = document.querySelectorAll('.feature-card');
    cards.forEach((card, i) => {
        gsap.to(card, {
            opacity: 1,
            y: 0,
            duration: 0.6,
            delay: i * 0.2,
            ease: 'back.out(1.7)'
        });
    });

    setTimeout(() => {
        gsap.to(features, {
            opacity: 0,
            duration: 0.8,
            ease: 'power2.in',
            onComplete: () => {
                features.style.display = 'none';
                init3D();
            }
        });
    }, 4000);
}

function init3D() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000);
    scene.fog = new THREE.Fog(0x000000, 15, 40);

    camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(12, 8, 15);
    camera.lookAt(0, 0, 0);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('canvas-container').appendChild(renderer.domElement);

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
    scene.add(ambientLight);

    const pointLight1 = new THREE.PointLight(0xff0080, 2, 60);
    pointLight1.position.set(8, 8, 8);
    scene.add(pointLight1);

    const pointLight2 = new THREE.PointLight(0x00d4ff, 2, 60);
    pointLight2.position.set(-8, 5, -8);
    scene.add(pointLight2);

    const pointLight3 = new THREE.PointLight(0xa855f7, 1.5, 50);
    pointLight3.position.set(0, -5, 8);
    scene.add(pointLight3);

    createNodes();
    animate();

    document.getElementById('canvas-container').classList.add('visible');
    document.querySelector('.ui-overlay').classList.add('visible');

    currentStage = 0;
    executeStage(0);
}

function createNodes() {
    SONGS.forEach((song, i) => {
        const size = 0.8;
        const geom = new THREE.SphereGeometry(size, 32, 32);
        const color = 0x00d4ff;

        const mat = new THREE.MeshPhongMaterial({
            color: color,
            emissive: color,
            emissiveIntensity: 0.6,
            shininess: 100
        });

        const node = new THREE.Mesh(geom, mat);

        // Random initial position
        const angle = (i / SONGS.length) * Math.PI * 2;
        const distance = 5;
        node.position.set(
            Math.cos(angle) * distance + (Math.random() - 0.5) * 2,
            (Math.random() - 0.5) * 4,
            Math.sin(angle) * distance + (Math.random() - 0.5) * 2
        );

        node.userData = { song: song, index: i };
        scene.add(node);
        nodes.push(node);

        createNodeLabel(node, i);
    });
}

function createNodeLabel(node, index) {
    const label = document.createElement('div');
    label.className = 'node-label candidate';
    label.id = `label-${index}`;

    const song = node.userData.song;

    label.innerHTML = `
        <div class="node-label-name">${song.name}</div>
        <div class="node-label-artist">${song.artist}</div>
        <div class="node-label-scores">
            <div class="node-label-score f"><strong>${song.feeling}</strong>Feeling</div>
            <div class="node-label-score s"><strong>${song.style}</strong>Style</div>
            <div class="node-label-score so"><strong>${song.sound}</strong>Sound</div>
            <div class="node-label-score p"><strong>${song.preference}</strong>Preference</div>
        </div>
    `;

    document.getElementById('nodeLabels').appendChild(label);
    node.userData.label = label;
}

function updateNodeLabels() {
    nodes.forEach(node => {
        const label = node.userData.label;
        if (!label) return;

        const vector = node.position.clone();
        vector.project(camera);

        const x = (vector.x * 0.5 + 0.5) * window.innerWidth;
        const y = (-(vector.y * 0.5) + 0.5) * window.innerHeight;

        label.style.left = x + 'px';
        label.style.top = y + 'px';
        label.style.display = vector.z > 1 ? 'none' : 'block';
    });
}

function showNodeLabel(index, show = true) {
    const label = document.getElementById(`label-${index}`);
    if (label) {
        if (show) {
            label.classList.add('visible');
        } else {
            label.classList.remove('visible');
        }
    }
}

function hideAllLabels() {
    nodes.forEach((node, i) => showNodeLabel(i, false));
}

function showAllLabels() {
    nodes.forEach((node, i) => {
        setTimeout(() => showNodeLabel(i, true), i * 150);
    });
}

function updateCenterInfo(songIndex) {
    const song = SONGS[songIndex];
    document.getElementById('centerName').textContent = song.name;
    document.getElementById('centerArtist').textContent = song.artist;
    document.getElementById('centerFeeling').textContent = song.feeling;
    document.getElementById('centerStyle').textContent = song.style;
    document.getElementById('centerSound').textContent = song.sound;
    document.getElementById('centerPref').textContent = song.preference;
    document.getElementById('centerSongInfo').style.display = 'block';
}

function animate() {
    requestAnimationFrame(animate);

    const time = Date.now() * 0.0001;
    camera.position.x = Math.sin(time * 0.25) * 12;
    camera.position.z = Math.cos(time * 0.25) * 15;
    camera.position.y = 8 + Math.sin(time * 0.15) * 3;
    camera.lookAt(0, 0, 0);

    updateNodeLabels();
    renderer.render(scene, camera);
}

const stages = [
    {
        title: "Ï¥àÍ∏∞ Î∞∞Ïπò",
        desc: "Random Distribution in 3D Space",
        centerSong: 0, // Sorry
        action: stage0
    },
    {
        title: "Feeling ÌïÑÌÑ∞ÎßÅ",
        desc: "Filtering by Valence - Emotional Brightness",
        centerSong: 3, // Levitating (highest feeling: 92)
        action: stage1
    },
    {
        title: "Style ÌïÑÌÑ∞ÎßÅ",
        desc: "Filtering by Danceability - Rhythm Suitability",
        centerSong: 2, // Shape of You (highest style: 83)
        action: stage2
    },
    {
        title: "Sound ÌïÑÌÑ∞ÎßÅ",
        desc: "Filtering by Energy - Sound Intensity",
        centerSong: 1, // Blinding Lights (well-balanced energy)
        action: stage3
    },
    {
        title: "ÏµúÏ¢Ö Ï∂îÏ≤ú",
        desc: "Final Top 4 Recommendations - Combined Score",
        centerSong: 0, // Back to Sorry
        action: stage4
    }
];

function executeStage(stage) {
    if (stage < 0 || stage >= stages.length) return;
    
    currentStage = stage;
    const stageData = stages[stage];
    
    document.getElementById('stageTitle').textContent = stageData.title;
    document.getElementById('stageDesc').textContent = stageData.desc;
    document.getElementById('progressBar').style.width = ((stage + 1) / stages.length * 100) + '%';
    
    // Update center song info
    centerSongIndex = stageData.centerSong;
    updateCenterInfo(centerSongIndex);
    
    // Update button states
    document.getElementById('prevBtn').disabled = (stage === 0);
    document.getElementById('nextBtn').disabled = (stage === stages.length - 1);
    
    stageData.action();
}

function nextStage() {
    if (currentStage < stages.length - 1) {
        executeStage(currentStage + 1);
    }
}

function prevStage() {
    if (currentStage > 0) {
        executeStage(currentStage - 1);
    }
}

function restartShow() {
    location.reload();
}

function stage0() {
    hideAllLabels();
    
    // Highlight center node
    setTimeout(() => {
        showNodeLabel(centerSongIndex, true);
        
        nodes[centerSongIndex].userData.label.className = 'node-label center visible';
        gsap.to(nodes[centerSongIndex].material.color, {
            r: 1, g: 0, b: 0.5,
            duration: 1
        });
        gsap.to(nodes[centerSongIndex].material.emissive, {
            r: 1, g: 0, b: 0.5,
            duration: 1
        });
        gsap.to(nodes[centerSongIndex].scale, {
            x: 1.5, y: 1.5, z: 1.5,
            duration: 1,
            ease: 'elastic.out(1, 0.5)'
        });
    }, 500);
}

function stage1() {
    // Feeling-based filtering - Center: Levitating (feeling: 92)
    showAllLabels();
    
    const center = SONGS[centerSongIndex];
    
    nodes.forEach((node, i) => {
        const song = node.userData.song;
        const diff = Math.abs(song.feeling - center.feeling);
        const distance = (diff / 40) * 5;
        
        const angle = (i / SONGS.length) * Math.PI * 2;
        
        gsap.to(node.position, {
            x: Math.cos(angle) * distance,
            y: (song.feeling - center.feeling) / 25,
            z: Math.sin(angle) * distance,
            duration: 2.5,
            ease: 'power2.inOut'
        });
        
        if (i === centerSongIndex) {
            gsap.to(node.position, { x: 0, y: 0, z: 0, duration: 2, ease: 'power2.inOut' });
            node.userData.label.className = 'node-label center visible';
            gsap.to(node.material.color, { r: 1, g: 0, b: 0.5, duration: 1 });
            gsap.to(node.material.emissive, { r: 1, g: 0, b: 0.5, duration: 1 });
        } else {
            node.userData.label.className = 'node-label candidate visible';
            gsap.to(node.material.color, { r: 0, g: 0.83, b: 1, duration: 1 });
            gsap.to(node.material.emissive, { r: 0, g: 0.83, b: 1, duration: 1 });
            gsap.to(node.scale, { x: 1, y: 1, z: 1, duration: 1 });
        }
    });
}

function stage2() {
    // Style-based filtering - Center: Shape of You (style: 83)
    const center = SONGS[centerSongIndex];
    
    nodes.forEach((node, i) => {
        const song = node.userData.song;
        const diff = Math.abs(song.style - center.style);
        const distance = (diff / 40) * 5;
        
        const angle = (i / SONGS.length) * Math.PI * 2;
        
        gsap.to(node.position, {
            x: (song.style - center.style) / 25,
            y: Math.cos(angle) * distance,
            z: Math.sin(angle) * distance,
            duration: 2.5,
            ease: 'power2.inOut'
        });
        
        if (i === centerSongIndex) {
            gsap.to(node.position, { x: 0, y: 0, z: 0, duration: 2 });
            node.userData.label.className = 'node-label center visible';
            gsap.to(node.material.color, { r: 1, g: 0, b: 0.5, duration: 1 });
            gsap.to(node.material.emissive, { r: 1, g: 0, b: 0.5, duration: 1 });
        }
    });
}

function stage3() {
    // Sound-based filtering - Center: Blinding Lights (sound: 73)
    const center = SONGS[centerSongIndex];
    
    nodes.forEach((node, i) => {
        const song = node.userData.song;
        const diff = Math.abs(song.sound - center.sound);
        const distance = (diff / 40) * 5;
        
        const angle = (i / SONGS.length) * Math.PI * 2;
        
        gsap.to(node.position, {
            x: Math.cos(angle) * distance,
            y: Math.sin(angle) * distance,
            z: (song.sound - center.sound) / 25,
            duration: 2.5,
            ease: 'power2.inOut'
        });
        
        if (i === centerSongIndex) {
            gsap.to(node.position, { x: 0, y: 0, z: 0, duration: 2 });
            node.userData.label.className = 'node-label center visible';
            gsap.to(node.material.color, { r: 1, g: 0, b: 0.5, duration: 1 });
            gsap.to(node.material.emissive, { r: 1, g: 0, b: 0.5, duration: 1 });
        }
    });
}

function stage4() {
    // Final - Combined score (back to Sorry as center)
    const center = SONGS[centerSongIndex];
    
    // Calculate distances for all songs
    const distances = nodes.map((node, i) => {
        const song = node.userData.song;
        const feelDiff = Math.abs(song.feeling - center.feeling);
        const styleDiff = Math.abs(song.style - center.style);
        const soundDiff = Math.abs(song.sound - center.sound);
        const prefDiff = Math.abs(song.preference - center.preference);
        
        const totalDiff = Math.sqrt(
            feelDiff**2 + styleDiff**2 + soundDiff**2 + prefDiff**2
        );
        
        return { index: i, distance: totalDiff };
    });
    
    distances.sort((a, b) => a.distance - b.distance);
    const top4Indices = distances.slice(1, 5).map(d => d.index); // Skip center (index 0)
    
    nodes.forEach((node, i) => {
        const song = node.userData.song;
        const distanceData = distances.find(d => d.index === i);
        const distance = (distanceData.distance / 80) * 4;
        
        const angle = (i / SONGS.length) * Math.PI * 2;
        
        gsap.to(node.position, {
            x: Math.cos(angle) * distance,
            y: (distanceData.distance - 60) / 35,
            z: Math.sin(angle) * distance,
            duration: 2.5,
            ease: 'power2.inOut'
        });
        
        const isTop4 = top4Indices.includes(i);
        const isCenter = (i === centerSongIndex);
        
        if (isCenter) {
            node.userData.label.className = 'node-label center visible';
            gsap.to(node.material.color, { r: 1, g: 0, b: 0.5, duration: 1 });
            gsap.to(node.material.emissive, { r: 1, g: 0, b: 0.5, duration: 1 });
            gsap.to(node.scale, { x: 1.5, y: 1.5, z: 1.5, duration: 1 });
        } else if (isTop4) {
            node.userData.label.className = 'node-label final visible';
            gsap.to(node.material.color, { r: 1, g: 0.84, b: 0, duration: 1 });
            gsap.to(node.material.emissive, { r: 1, g: 0.84, b: 0, duration: 1 });
            gsap.to(node.scale, { x: 1.3, y: 1.3, z: 1.3, duration: 1, ease: 'elastic.out(1, 0.5)' });
        } else {
            gsap.to(node.material, { opacity: 0.2, transparent: true, duration: 1.5 });
            setTimeout(() => showNodeLabel(i, false), 1000);
        }
    });
}

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});

// Start the show
initApp();
</script>
</body>
</html>